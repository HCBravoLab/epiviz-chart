<script>
    epiviz.ChartDataBehavior = {

        properties: {
            transformData: {
                type: Boolean,
                notify: true,
                value: false
            },

            transformDataFunc: {
                type: String,
                notify: true
            }
        },

        //
        //  output data format 
        //  {
        //      columns: Collection <Object> {measurement-id: <Epiviz measurement>}
        //      values : Array  [measurement-id: Val <Integer>, row: rowInfo]
        //  }
        // TODO: json format
        epivizToJSON: function(data) {

            if(!this.transformData) {
                return data;
            }

            var fromDataMeasurements = [];
            var range = this.range;

            var firstGlobalIndex = data.firstSeries().globalStartIndex();
            var lastGlobalIndex = data.firstSeries().globalEndIndex();

            data.foreach(function(measurement, series) {
                fromDataMeasurements.push(measurement);
                var firstIndex = series.globalStartIndex();
                var lastIndex = series.globalEndIndex();
                if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
                if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
            });

            var nItems = lastGlobalIndex - firstGlobalIndex;

            var i, index;
            var grid = {};
            grid.measurements = fromDataMeasurements;
            grid.columns = {};

            grid.measurements.forEach(function(m) {
                grid.columns[m.datasourceId() + "-" + m.id()] = m;
            });

            grid.values = [];
            var nSeries = fromDataMeasurements.length;
            for (i = 0; i < nItems; ++i) {
                index = i + firstGlobalIndex;
                var valArray = {};
                
                var row = {};
                var rowData = data.getSeries(fromDataMeasurements[0]).getRowByGlobalIndex(index);
                row.start = rowData.start();
                row.end = rowData.end();
                row.metadata = rowData.rowMetadata();
                row.strand = rowData.strand();
                row.index = rowData.index();
                row.globalIndex = rowData.globalIndex();
                row.id = rowData.id();
                row.seqName = rowData.seqName();
                valArray.row = row;

                grid.measurements.forEach(function(m) {
                    var cellX = data.getSeries(m).getByGlobalIndex(index);
                    valArray[m.datasourceId() + "-" + m.id()] = cellX.value;
                });

                grid.values.push(valArray);
            }
            return grid;
        },

        _getElementSearch: function(gene, currentChild, pDom) {

            var dataManagerElem = document.querySelector('epiviz-data-source');

            if (dataManagerElem != null) {
                var dataManager = dataManagerElem.dataManager;

                dataManager.search(function(data) {
                    pDom.$.geneSearch.suggestions(data);
                }, gene);
            }
        },

        _getElementSeqInfo: function(currentChild, pDom) {

            var dataManagerElem = document.querySelector('epiviz-data-source');

            if (dataManagerElem != null) {
                var dataManager = dataManagerElem.dataManager;
                dataManager.getSeqInfos(function(data) {
                    var seqinfo = {};
                    data.forEach(function(s) {
                        seqinfo[s.seqName] = s;
                    });
                    currentChild.seqInfo = seqinfo;
                });
            }
        },

        _getElementData: function(currentChild, pDom, measurements) {
            var self = this;
            var dims = currentChild.dims || currentChild.getAttribute("dim-s");

            if (typeof(dims) == "string") {
                dims = JSON.parse(dims);
            }

            // var id = self._generateChartId();
            var mSet = new epiviz.measurements.MeasurementSet();
            var tMeasurements = [];

            if(dims != null && dims.length > 0) {
                for (var idim = 0; idim < dims.length; idim++) {
                    var mtdx = measurements[dims[idim]];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }
            }
            else if(currentChild.measurements != null && currentChild.measurements.length > 0 ){
                for (var idim = 0; idim < currentChild.measurements.length; idim++) {
                    var mtdx = currentChild.measurements[idim];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }
            }

            var id = currentChild.plotId;
            if(tMeasurements.length != 0) {
                currentChild.range = currentChild.range || self.range || pDom.range;
                currentChild.measurements = tMeasurements;
                var chartMeasMap = {};
                chartMeasMap[id] = mSet;

                var dataManagerElem = document.querySelector('epiviz-data-source[provider-id$="' + tMeasurements[0].dataprovider + '"]');

                if (dataManagerElem != null) {
                    var dataManager = dataManagerElem.dataManager;

                    dataManager.getData(currentChild.range, chartMeasMap, function(id, data) {
                        //currentChild.data = data;
                        var dataChartElem = pDom.querySelector('[plot-id$="' + id + '"]') || Polymer.dom(pDom).querySelector('[plot-id$="' + id + '"]');
                        if(dataChartElem) {
                            dataChartElem.data = pDom.transformFunc(data);
                        }
                    });
                }
            }
        },

        _updateChart: function(cId) {

            if(cId == undefined) {return;}
            var self = this;
            var currentChild = Polymer.dom(self).querySelector('[plot-id$="' + cId + '"]');
            var dims = currentChild.dimS || currentChild.getAttribute("dim-s");
            $('#' + cId).empty();

            if (typeof(dims) == "string") {
                dims = JSON.parse(dims);
            }

            var mSet = new epiviz.measurements.MeasurementSet();
            var tMeasurements = [];

            if(dims != null && dims.length > 0) {
                for (var idim = 0; idim < dims.length; idim++) {
                    var mtdx = self.measurements[dims[idim]];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));
                    tMeasurements.push(mtdx);
                }
            }
            else if(currentChild.measurements != null && currentChild.measurements.length > 0 ){
                for (var idim = 0; idim < currentChild.measurements.length; idim++) {
                    var mtdx = currentChild.measurements[idim];
                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }
            }

            if(tMeasurements.length != 0) {
                currentChild.range = currentChild.range || self.range;
                currentChild.measurements = tMeasurements;
                var chartMeasMap = {};
                chartMeasMap[cId] = mSet;

                var dataManagerElem = document.querySelector('epiviz-data-source[provider-id$="' + tMeasurements[0].dataprovider + '"]');

                if (dataManagerElem != null) {
                    var dataManager = dataManagerElem.dataManager;

                    dataManager.getData(currentChild.range, chartMeasMap, function(id, data) {
                        //currentChild.data = data;
                        var dataChartElem = Polymer.dom(self).querySelector('[plot-id$="' + id + '"]');

                        dataChartElem.data = self.transformFunc(data);
                    });
                }
            }
        }
    }
</script>