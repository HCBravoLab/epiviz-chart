<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">

<script>
    epivizChartBehavior = {
        properties : {
            dimS: {
                type: Array,
                notify: true
            },

            useDefaultDataProvider: {
                type: Boolean,
                notify: true
            },

            data: {
                type: Object,
                notify: true,
                observer: '_dataChanged'
            },

            plotId: {
                type: String,
                reflectToAttribute: true,
                notify: true
            },

            measurements: {
                type: Array,
                notify: true,
                observer: '_measurementsChanged'
            },

            range: {
                type: Object,
                notify: true
            },

            chartSettings: {
                type: Object,
                notify: true,
                observer: '_chartSettingsChanged'
            }
        },

        observers: [
            '_dimChanged(dimX.*, dimY.*, dimS.*)'
        ],

        listeners: {
            'iron-resize': '_onResize'
        },

        _onResize: function() {
            // this._measurementsChanged();
            if(this.chart != null) {
                this.chart._properties.width = this.offsetWidth;
                this._draw();
            }
        },

        _generatePlotId: function() {
            var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            var result = '';
            var size = 7;

            for (var i = 0; i < size; ++i) {
                result += chars[Math.round(Math.random() * (chars.length - 1))];
            }
            return 'epiviz-' + result;
        },

        _dimChanged: function() {

            $('#' + this.plotId).empty();
            this.fire('dimChanged', {
                id: this.plotId
            });
        },

        _chartSettingsChanged: function() {
            var self = this;
            self.chart.setCustomSettingsValues(self.chartSettings);
            self._dataChanged();
        },

        _measurementsChanged: function() {

            var self = this;

            if (this.measurements != null && self.config != null) {

                $('#' + self.plotId).empty();
                var mSet = new epiviz.measurements.MeasurementSet();

                for (var i = 0; i < self.measurements.length; i++) {

                    var measurement = self.measurements[i];
                    mSet.add(new epiviz.measurements.Measurement(
                        measurement.id,
                        measurement.name,
                        measurement.type,
                        measurement.datasourceId,
                        measurement.datasourceGroup,
                        measurement.dataprovider,
                        measurement.formula,
                        measurement.defaultChartType,
                        measurement.annotation,
                        measurement.minValue,
                        measurement.maxValue,
                        measurement.metadata
                    ));
                }

                self.visConfigSelection = new epiviz.ui.controls.VisConfigSelection(mSet);
                // self.chartType = new epiviz.plugins.charts.LineTrackType(self.config);
                self.chartType = self._createChart();

                self.chartProperties = new epiviz.ui.charts.VisualizationProperties(
                    self.offsetWidth || self.chartType.defaultWidth(),
                    self.chartType.defaultHeight(),
                    self.chartType.defaultMargins(),
                    self.visConfigSelection,
                    self.chartType.defaultColors(),
                    null,
                    self.chartType.customSettingsValues(),
                    self.chartType.customSettingsDefs(), [],
                    null
                );

                self.chart = self.chartType.createNew(self.plotId, $('#' + self.plotId), self.chartProperties);

                if(self.chartSettings != null || self.chartSettings != undefined) {
                    self.chart.setCustomSettingsValues(self.chartSettings);
                }
                else {
                    self.chartSettings = self.chart._customSettingsValues;
                }

                self._initializeSettingsDialog(self.chartType.customSettingsDefs(), self.chartSettings);

                // Listen to hover event on the chart
                self.chart.onHover().addListener(new epiviz.events.EventListener(
                    function(e) {
                        var id = e.id;
                        var data = e.args;
                        self.hover(data);
                        self.fire('hover', {
                            id: id,
                            data: data
                        });
                    }
                ));

                self.chart.onUnhover().addListener(new epiviz.events.EventListener(
                    function(e) {
                        var id = e.id;
                        var data = e.args;
                        self.unHover();
                        self.fire('unHover', {
                            id: id
                        });
                    }
                ));

                if (self.useDefaultDataProvider) {

                    self.measurements = self.measurements || [{
                        'id': 'genes',
                        'name': 'Genes',
                        'type': 'range',
                        'datasourceId': 'genes',
                        'datasourceGroup': 'genes',
                        'dataprovider': 'umd',
                        'formula': null,
                        'defaultChartType': "Genes Track",
                        'annotation': null,
                        'minValue': null,
                        'maxValue': null,
                        'metadata': ['gene', 'entrez', 'exon_starts', 'exon_ends']
                    }];

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                    var chartMeasMap = {};
                    chartMeasMap[self.plotId] = self.visConfigSelection.measurements;
                    var dataProviderFactory = new epiviz.data.DataProviderFactory(self.config);
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        self.data = data;
                    });
                }
            }
        },

        _dataChanged: function() {
            if (this.data != null && this.chart != null) {
                this._draw();
            }
        },

        hover: function(data) {
            this.chart.doHover(data);
        },

        unHover: function() {
            this.chart.doUnhover();
        }
    }
</script>