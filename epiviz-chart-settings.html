<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../paper-button/paper-button.html">
<!--<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">-->
<!--<link rel="import" href="../paper-listbox/paper-listbox.html">-->
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-dropdown-input/paper-dropdown-input.html">
<!--<link rel="import" href="../paper-item/paper-item.html">-->
<link rel="import" href="../paper-styles/color.html">
<link rel="import" href="../paper-styles/typography.html">
<link rel="import" href="../paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<!--<link rel="import" href="../paper-dialog-behavior/paper-dialog-shared-styles.html">-->
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="epiviz-chart-settings">

    <template>
        <style>
        /*:host {
            display: inline-block;
            width:90%;
        }*/

        /*::shadow #settings {
            width: 800px;
        }*/

        /*paper-dialog {
            width: 40%;
            height: 40%;
        }*/

        /*:host {*/
            /*--paper-dialog: {
                height: 50%;
                width: 50%;
            };*/

            /*--paper-dialog-scrollable: {
                width: 80%;
                height: 80%;
            };*/
        /*}*/
        </style>

        <!-- local DOM goes here -->
        <div id="settings">
            <!--no-overlap horizontal-align="left" vertical-align="top"-->
            <paper-dialog id="modal" modal>
                <h2>Chart Settings</h2>
                <form is="iron-form" id="formSettings">
                    <paper-dialog-scrollable id="scrollContent">

                        <template is="dom-repeat" items="{{defs}}">
                            <template is="dom-if" if="[[_settingType(item.type, 'boolean')]]">
                                <paper-toggle-button name="{{item.id}}" label="{{item.label}}" checked="[[_getValue(item.id)]]"></paper-toggle-button>
                                <iron-label for="{{item.id}}">{{input.label}}</iron-label>
                            </template>
                            <template is="dom-if" if="[[_settingType(item.type, 'string')]]">
                                <paper-input name="{{item.id}}" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                            </template>
                            <template is="dom-if" if="[[_settingType(item.type, 'number')]]">
                                <paper-input name="{{item.id}}" type="number" label="{{item.label}}" value="[[_getValue(item.id)]]"></paper-input>
                            </template>
                            <template is="dom-if" if="[[_settingType(item.type, 'array')]]">
                                <paper-dropdown-input name="{{item.id}}" value="[[_getValue(item.id)]]" label="{{item.label}}" items="{{item.possibleValues}}"></paper-dropdown-input>
                            </template>
                        </template>
                        
                    </paper-dialog-scrollable>
                    <paper-button id="submit" raised>Apply</paper-button>
                    <paper-button id="cancel" raised>Cancel</paper-button>
                </form>
            </paper-dialog>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-chart-settings',

            /* Properties that can be defined on the element */
            properties: {

                defs: {
                    type: Object,
                    notify: true
                },

                vals: {
                    type: Object,
                    notify: true
                }
            },

            listeners: {
                'submit.click': '_submit',
                'cancel.click': '_cancel'
            },

            _settingType: function(type, expected) {
                if(expected == 'array') {
                    expected = ['categorical', 'measurementsMetadata', 'measurementsAnnotation'];
                    return expected.indexOf(type) === -1 ? false : true;

                    // if(expected.indexOf(type) != -1) {
                    //     var def = null;
                    //     for(var i=0; i< this.defs.length; i++){
                    //         if(this.defs[i].id == id) {
                    //             def = this.defs[i];
                    //         }
                    //     }

                    //     if(def.possibleValues === null) {return false;}
                    //     else {return true;}
                    // }
                }
                return type == expected;
            },

            _getValue: function(id) {
                // var def = null;
                return this.vals[id];
            },
            
            _submit: function(event) {
                this.$.formSettings.submit();
            },

            _form_submit: function(event) {
                this.vals = event.detail;
                //  format vals types
                this.defs.forEach(function(def) {
                    if(def.type == "number") {
                        self.vals[def.id] = parseInt(self.vals[def.id]);
                    }
                });
                this.callback(this.vals);
                this.closeSettings();
            },

            _cancel: function(event) {
                this.closeSettings();
            },

            showSettings: function(target, callback) {
                this.callback = callback;
                this.$.modal.positionTarget = target;
                this.$.modal.open();
            },

            closeSettings: function() {
                this.$.modal.close();
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;

                self.$.scrollContent.dialogElement = self.$.modal;
                self.$.formSettings.addEventListener('iron-form-submit', this._form_submit.bind(self));
            },


            attached: function() {
                for(var i=0; i< this.defs.length; i++){
                        // def = this.defs[i];
                    var id = this.defs[i].id;
                    expected = ['categorical', 'measurementsMetadata', 'measurementsAnnotation']
                    if(expected.indexOf(this.defs[i].type) != -1) {
                        if(this.defs[i].possibleValues == null) {
                            this.defs[i].possibleValues = [this.vals[id]];
                        }
                        else if(this.defs[i].possibleValues.indexOf(this.vals[id]) === -1) {
                            this.defs[i].possibleValues.push(this.vals[id]);
                        }
                    }
                }
            }
        });
    </script>
</dom-module>