<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../epiviz-imports/epiviz-common-js.html">

<script src="src/cyto-chromosome-vis/cyto-chromosome.js"></script>

<dom-module id="epiviz-ideogram-track">
    <template>
        <style>
        :host {
            display: inline-block;
            min-width: 400px;
        }
        </style>

        <!-- local DOM goes here -->
        <div id="chart">
            <div id="{{plotId}}"></div>
        </div>
    
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-ideogram-track',

            /* Properties that can be defined on the element */
            properties: {

                chromosome: {
                    type: String,
                    notify: true
                },

                start: {
                    type: Number,
                    notify: true
                },

                end: {
                    type: Number,
                    notify: true
                },

                plotId: {
                    type: String,
                    reflectToAttribute: true,
                    notify: true
                },

                range: {
                    type: Object,
                    notify: true
                }
            },

            observers: [
                '_rangeChanged(chromosome.*, start.*, end.*)'
            ],

            _generatePlotId: function() {
                var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var result = '';
                var size = 7;

                for (var i = 0; i < size; ++i) {
                    result += chars[Math.round(Math.random() * (chars.length - 1))];
                }

                return 'epiviz-' + result;
            },

            _rangeChanged: function() {

                if (this.chromosome != null && this.start != null && this.end != null) {
                    if(this.plotId) {
                        this._draw();
                    }
                }
            },

            hover: function(data) {
                this.chart.doHover(data);
            },

            unHover: function() {
                this.chart.doUnhover();
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;

                self.plotId = self.plotId || self._generatePlotId();
                var parent = self.parentNode;
                
                if(parent.nodeName === "IRON-COLLAPSE") {
                    parent = parent.parentNode;
                }

                parent.addEventListener('hoverAllCharts', function(e) {
                    self.chart.hover(e.detail.data);
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    self.chart.unHover();
                }.bind(self));

                self.chromosomeFactory = cyto_chr;
                self._rangeChanged();
            },

            _draw: function() {

                var self = this;

                self.segment = self.chromosome.replace("chr", "");

                self.chart = self.chromosomeFactory.chromosome()
                    .segment(self.segment)
                    // .resolution("850")
                    // .useRelative(false)
                    .showAxis(true)
                    .target(self.$$("#" + self.plotId))
                    // .height(100)
                    .width(300)
                    .render();

                // TODO: use callback instead after the chart is rendered
                setTimeout(function(){ 
                    self.chart.on("selectorhover", function(e) {
                        self.fire('hover', {
                            data: self.chartObject
                        });
                    }.bind(self));
                    
                    self.chart.on("selectorunhover", function(e) {
                        self.fire('unHover', {
                            data: null
                        });
                    }.bind(self));

                    self.chart.newSelector(self.start, self.end);
                    self.chartObject = new epiviz.ui.charts.ChartObject(self.plotId, self.start, self.end, undefined, undefined, undefined, undefined, undefined);
                }, 1000);
            }
        });
    </script>
</dom-module>