<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../epiviz-imports/epiviz-common-css.html">
<link rel="import" href="../epiviz-imports/epiviz-common-js.html">

<link rel="import" href="chart-behavior.html">
<link rel="import" href="chart-settings.html">
<link rel="import" href="chart-colors.html">

<link rel="import" href="epiviz-chart-settings.html">
<link rel="import" href="chart-data-behavior.html">

<link rel="import" href="epiviz-genes-track.html">
<link rel="import" href="epiviz-ideogram-track.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<dom-module id="epiviz-navigation">

    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                display: inline-block;
                border: 1px solid black;
                padding: 10px;
                resize: both;
                overflow: auto;
                transition:width 0.01s, height 0.01s;
                margin: 10px;
                width: auto;
                height: auto;
            }

            .container {
                width: 600px;
                display: inline;
            }

            .flex {
                @apply(--layout-horizontal);
                align-items: center;
            }

            .flexchild {
                @apply(--layout-flex);
                padding: 10px;
                flex: 1 1 auto;
            }

            .flex-end-justified {
                @apply(--layout-horizontal);
                @apply(--layout-end-justified);
            }

            paper-icon-button {
                background-color: #dedede;
                color: black;
                border-radius: 3px;
                padding: 2px;
                width: 28px;
                height: 28px;
            }
        </style>

        <!-- local DOM goes here -->
        <div>
            <button class="collapse-header" on-click="toggleHeader">Collapse</button>
            <button on-click="cloneNavigation">Clone</button>
        </div>
        <template restamp="true" is="dom-if" if="{{!collapsed}}">
            <!--<epiviz-genes-track range="{{range}}" use-default-data-provider="true"></epiviz-genes-track>-->
            <!--<epiviz-ideogram-track chromosome="{{chr}}" start="{{start}}" end="{{end}}"></epiviz-ideogram-track>-->
            <epiviz-ideogram-track id="navTrack" chromosome="{{chr}}" start="{{start}}" end="{{end}}"></epiviz-ideogram-track>
        </template>
        
        <iron-collapse id="navHeader">
            <template restamp="true" is="dom-if" if="{{collapsed}}">
                <div class="container flex">
                    <div class="flexchild">
                        <paper-icon-button title="move left" icon="icons:chevron-left" on-click="moveLeft"></paper-icon-button>
                        <paper-icon-button title="move right" icon="icons:chevron-right" on-click="moveRight"></paper-icon-button>
                        <paper-icon-button title="zoom out" icon="icons:zoom-out" on-click="zoomOut"></paper-icon-button>
                        <paper-icon-button title="zoom in" icon="icons:zoom-in" on-click="zoomIn"></paper-icon-button>
                    </div>
                    <div class="flexchild">
                        <paper-input value="{{_strRange]]" label="Chromosome Location" on-change="_updateStrRange"></paper-input>
                    </div>
                    <div class="flexchild">
                        <paper-autocomplete id="geneSearch" label="Search Gene/Probe" remote-source="true" min-length="2" 
                            on-autocomplete-selected="_selectGene"
                            on-autocomplete-change="_searchGene"
                            value-property="gene"
                            text-property="gene">
                            <template autocomplete-custom-template>
                                <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                                <div>[[item.gene]] [[item.seqName]]: [[item.start]] - [[item.end]]</div>
                                <paper-ripple></paper-ripple>
                                </paper-item>
                            </template>
                        </paper-autocomplete>
                    </div>
                </div>
                <content id="chartNav" select=".charts"></content>
            </template>
        </iron-collapse>
        
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-navigation',
            behaviors: [epiviz.ChartBehavior, epiviz.ChartDataBehavior, Polymer.IronResizableBehavior],

            /* Properties that can be defined on the element */
            properties: {

                chr: {
                    type: String
                    // notify: true
                },

                start: {
                    type: Number
                    // notify: true
                },

                end: {
                    type: Number,
                    // notify: true
                },

                range: {
                    type: Object,
                    // notify: true,
		            computed: 'getGenomicRange(chr, start, end)',
                    observer: '_rangeUpdate'
                },
                  
                _strRange: {
                    type: String,
                    notify: true,
		            computed: 'getStrRange(chr, start, end)'
                },

                stepRatio: {
                    type: Number,
                    notify: true,
                    value: 0.2
                },

                zoomRatio: {
                    type: Number,
                    notify: true,
                    value: 0.2
                },

                collapsed: {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                initializeGeneEnvironments: {
                    type: Array
                },

                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {
                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "http://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,
                            colorPalettes: [],
                            maxSearchResults: 12
                        };
                        return epiviz.Config.SETTINGS;
                    }
                }
            },

            listeners: {
                'hover': 'onHover',
                'unHover': 'onUnhover'
            },

            toggleHeader: function(event) {
                this.$.navHeader.toggle();
                this.collapsed = !this.collapsed;
                event.preventDefault();
                event.stopPropagation();
                // this._getData();
            },

            onHover: function(e) {
                this.fire('hoverAllCharts', {
                    data: e.detail.data
                });
                // this.fire('hover', {
                //     data: e.detail.data
                // });
                // e.preventDefault();
                // e.stopPropagation();
            },

            onUnhover: function(e) {
                this.fire('unHoverAllCharts', {
                    data: null
                });
                // this.fire('unHover', {
                //     data: e.detail.data
                // });
                // e.preventDefault();
                // e.stopPropagation();
            },

            _rangeUpdate: function() {
                var self = this;
                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    currentChild.range = self.range;
                    if(Polymer.dom(self).parentNode.nodeName === "EPIVIZ-ENVIRONMENT") {
                        self._getElementData(currentChild, self, self.parentNode.measurements);  
                    }
                }
            },

            _searchGene: function(e) {
                var self = this;
                var gene = e.detail.option.text;
                var field = this.$.geneSearch;

                if (self.useDefaultDataProvider) {

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                    var dataProviderFactory = new epiviz.data.DataProviderFactory(new epiviz.Config(self.configSrc));
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.search(function(data) {
                        field.suggestions(data);
                    }, gene);
                }
                else {
                    if(Polymer.dom(self).parentNode.nodeName === "EPIVIZ-ENVIRONMENT") {
                        var result = self._getElementSearch(gene, self, self);  
                    }
                }
            },

            _selectGene: function(e) {
                var selected= e.detail.option;

                this.chr = selected.seqName;
                this.start = selected.start - Math.round(selected.start * 0.01);
                this.end = selected.end + Math.round(selected.end * 0.01);
            },

            _updateStrRange: function(e) {
                var update = e.target.value;
                var split = update.split(":");
                var chr = split[0];
                var rsplit = split[1].split("-");
                var start = parseInt(rsplit[0]);
                var end = parseInt(rsplit[1]);

                this.chr = chr;
                this.start = start;
                this.end = end;
            },

            moveLeft: function(e) {
                var width = this.end - this.start;
                var newStart = this.start - Math.round(width * this.stepRatio);
                var newEnd = newStart + width;
                
                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            moveRight: function(e) {
                var width = this.end - this.start;
                var newStart = this.start + Math.round(width * this.stepRatio);
                var newEnd = newStart + width;

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            zoomIn: function(e) {
                var width = Math.round(this.end - this.start);
                var mid = Math.round(this.start + (width/2));
                var newWidth = Math.round(width * (1 - this.zoomRatio));
                var newStart = Math.round(mid - (newWidth * 0.5));
                var newEnd = Math.round(this.start + newWidth);

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            zoomOut: function(e) {
                var width = Math.round(this.end - this.start);
                var mid = Math.round(this.start + (width/2));
                var newWidth = Math.round(width * (1 + this.zoomRatio));
                var newStart = Math.round(mid - (newWidth * 0.5));
                var newEnd = Math.round(this.start + newWidth);

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
            },

            getStrRange: function(chr, start, end) {
                return chr + ": " + start + " - " + end;
            },

            getGenomicRange: function(chr, start, end) {
                    return new epiviz.datatypes.GenomicRange(chr, start, end-start);
            },

            _getData: function() {
                var self = this;
                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    currentChild.range = self.range;
                    if(Polymer.dom(self).parentNode.nodeName === "EPIVIZ-ENVIRONMENT") {
                        self._getElementData(currentChild, self, self.parentNode.measurements);  
                    }
                }
            },


            cloneNavigation: function() {
                var self = this;

                var navElem = document.createElement('epiviz-navigation');
                navElem.chr = self.chr;
                navElem.start = self.start;
                navElem.end = self.end;
                navElem.className = "charts";

                Polymer.dom(self.parentNode).appendChild(navElem);

                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    var childElem = document.createElement(currentChild.nodeName);
                    childElem.className = "charts";
                    childElem.dimS = currentChild.dimS;
                    childElem.measurements = currentChild.measurements;
                    childElem.chartSettings = currentChild.chartSettings;
                    childElem.chartColors = currentChild.chartColors;

                    Polymer.dom(navElem).appendChild(childElem);
                }
            },

            // Initialization that should happen or use FactoryImpl 
            // created: function() {},
            
            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;

                // listen to events 
                var parent = self.parentNode;
                parent.addEventListener('hoverAllCharts', function(e) {
                    if(!self.collapsed) {
                        if(e.detail.data.overlapsWith(self.$$("#navTrack").chartObject)) {
                            self.$$("#navTrack").hover();
                        }
                    }
                    else {
                        var numChildren = self.getEffectiveChildren().length;
                        for (var index = 0; index < numChildren; index++) {
                            var currentChild = self.getEffectiveChildren()[index];
                            currentChild.hover(e.detail.data);
                        }
                    }
                }.bind(self));

                parent.addEventListener('unHoverAllCharts', function(e) {
                    if(!self.collapsed) {
                        self.$$("#navTrack").unHover();
                    }
                    else {
                        var numChildren = self.getEffectiveChildren().length;
                        for (var index = 0; index < numChildren; index++) {
                            var currentChild = self.getEffectiveChildren()[index];
                            currentChild.unHover();
                        }
                    }
                }.bind(self));

                // if(self.collapsed) {
                    var numChildren = self.getEffectiveChildren().length;
                    for (var index = 0; index < numChildren; index++) {
                        var currentChild = self.getEffectiveChildren()[index];
                        currentChild.range = self.range;
                        self._getElementData(currentChild, self, self.parentNode.measurements);
                    }
                // }

                // self._rangeUpdate();

                if (self.useDefaultDataProvider) {

                    // self.measurements = self.measurements || [{
                    //     'id': 'genes',
                    //     'name': 'Genes',
                    //     'type': 'range',
                    //     'datasourceId': 'genes',
                    //     'datasourceGroup': 'genes',
                    //     'dataprovider': 'umd',
                    //     'formula': null,
                    //     'defaultChartType': "Genes Track",
                    //     'annotation': null,
                    //     'minValue': null,
                    //     'maxValue': null,
                    //     'metadata': ['gene', 'entrez', 'exon_starts', 'exon_ends']
                    // }];

                    // self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(new epiviz.Config(self.configSrc));
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getSeqInfos(function(data) {
                        var seqinfo = {};
                        data.forEach(function(s) {
                            seqinfo[s.seqName] = s;
                        });
                        self.seqInfo = seqinfo;
                    });
                }
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;
                self.plotId = self.plotId || self._generatePlotId();
                // style observer on charts
                // self.scopeSubtree(self.$.chart, true);

                self.config = new epiviz.Config(self.configSrc);

                self.range = self.getGenomicRange(self.chr, self.start, self.end);

                if(self.transformDataFunc) {
                    self.transformFunc = new Function('return ' + self.transformDataFunc);
                }
                else {
                    self.transformFunc = self.epivizToJSON;
                }
            },

            _createChart: function() {
                return null;
            }
        });
    </script>
</dom-module>