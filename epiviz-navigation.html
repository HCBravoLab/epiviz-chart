<!-- Polymer dependency -->
<link rel="import" href="../polymer/polymer.html">

<!-- Epiviz imports dependency -->
<link rel="import" href="../epiviz-imports/epiviz-common-js.html">

<!-- Epiviz behaviors dependency -->
<link rel="import" href="chart-behavior.html">
<link rel="import" href="chart-settings.html">
<link rel="import" href="chart-colors.html">

<!-- Epiviz data behaviors dependency -->
<link rel="import" href="chart-data-behavior.html">
<link rel="import" href="chart-add-behavior.html">
<link rel="import" href="chart-workspace-behavior.html">
<link rel="import" href="chart-grid-behavior.html">

<!-- Chart elements dependency -->
<link rel="import" href="epiviz-genes-track.html">
<link rel="import" href="epiviz-ideogram-track.html">

<!-- Polymer Behavior dependency -->
<link rel="import" href="../iron-fit-behavior/iron-fit-behavior.html">

<!-- External Polymer Styles/elements dependency -->
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<!--
`<epiviz-navigation>` is similar to `<epiviz-environment>`. It is a wrapper element that handles events 
    and brushing across all of its children `<epiviz-charts>` elements. In addition, `<epiviz-navigation>`
    has a collapse and expand feature. When collapsed, it hides its children and provides a smaller compact ideogram-view of the current 
    genomic location of the element. When expanded, features such are navigating along the chromosome, 
    or navigating to a gene location are available.

Most element attributes are defined in `<epiviz.ChartBehavior>` element.

To use, add `<epiviz-navigation>` in the page

      <epiviz-navigation></epiviz-navigation>

@demo demo/index-navigation.html Example page showing a navigation element with charts 
-->

<dom-module id="epiviz-navigation">
    <!--<link rel="import" href="../epiviz-imports/epiviz-common-css.html">-->
    <template>
        <style include="shared-settings"></style>
        <style>
            :host {
                display: inline-block;
                /* border: none; */
                resize:both;
                /* min-width: 33%; */
                width: 99%;
                margin:10px;
                border-radius: 5px;
                /* height: 100%; */
                /* border: 1px solid black; */
                /* border-radius: 10px; */
                transition:width 0.01s, height 0.01s;
                @apply(--shadow-elevation-2dp);
            }
            
            .flex {
                @apply(--layout-horizontal);
                align-items: center;
            }

            .flexchild {
                /* @apply(--layout-flex); */
                padding: 10px;
                /* flex: 1 1 auto; */
            }

            #disableHeader {
                pointer-events: none;
                opacity: 0.4;
            }

            paper-button {
                display: inline-block;
                background: #4285f4;
                color: #fff;
                vertical-align: middle;
            }

            paper-icon-button {
                background-color: #dedede;
                color: black;
                border-radius: 3px;
                padding: 2px;
                width: 28px;
                height: 28px;
            }

            #logo {
                vertical-align: middle;
            }

            .paper-header {
                background-color: #e0e2e2;
                padding-left: 5px;
            }

            paper-menu-button {
                float: right;
            }

            iron-label {
                color: #4285f4;
                font-weight: bold;
                font-size: 16px;
            }

            .isempty {
                position: relative;
                top: 50%;
                left: 50%;
                transform: translateX(-50%) translateY(-50%);
            }

            #header {
                height: 50px;
                /* linear-gradient(white, #e0e2e2) */
            }

            .content {
                min-height:200px;
                padding: 5px;
                display: grid;
                grid-template-columns: repeat(6, 1fr);
                grid-auto-rows: max-content;
                grid-row-gap: 2px;
                grid-column-gap: 2px;
            }

            #chartSettingsContainer {
                position:absolute;
                top: 0;
                right: 0;
                border: 1px solid #000;
                border-radius: 2px;
                margin:1px;
            }

            ::content .grid-plot {
                grid-row: span 1;
                grid-column: span 2;
            }

            ::content .grid-track {
                grid-column: span 6;
                grid-row: span 1;
            }

            ::content .grid-navigation {
                grid-row: span 1;
                grid-column: span 6;
                order: 2;
            }
        </style>

            <div id="header" class="paper-header">
                <iron-label>EPIVIZ NAVIGATION</iron-label>
                <a href="http://epiviz.github.io" target="_blank" hidden$={{noLogo}}>
                    <img id="logo" src="epiviz_4_logo_medium.png" alt="Epiviz" width="100" height="21">
                </a> 
                <div style="display:inline" hidden$="{{collapsed}}">
                    <epiviz-add-chart id="addChart"></epiviz-add-chart>  
                </div>  
<!--                 <paper-button raised class="collapse-header" on-click="toggleHeader">Collapse</paper-button>
                <paper-button raised on-click="cloneNavigation">Clone</paper-button>     -->
                <paper-menu-button dynamic-align vertical-align="bottom" vertical-offset=24>
                    <paper-icon-button icon="menu" class="dropdown-trigger"></paper-icon-button>
                    <paper-menu class="dropdown-content">
                        <paper-item toggles on-click="toggleSelected">Delete</paper-item>
                        <paper-item on-click="cloneNavigation">Clone</paper-item>
                        <paper-item on-click="toggleHeader">{{_toggleText}}</paper-item>
                    </paper-menu>
                </paper-menu-button>       
            </div>
            <div>
                <!-- <template is="dom-if" if="{{collapsed}}"> -->
                <div hidden$="{{!collapsed}}">
                    <epiviz-ideogram-track style="width:400px;" gene-in-range="{{geneInRange}}" id="navTrack" chromosome="{{chr}}" start="{{start}}" end="{{end}}"></epiviz-ideogram-track>
                </div>
                <!-- </template> -->

                <!-- <template is="dom-if" if="{{!collapsed}}"> -->
                    <iron-collapse id="navHeader" hidden$="{{collapsed}}" opened>
                        <div class="container flex" id="{{_headerName}}">
                            <div class="flexchild">
                                <paper-icon-button title="move left" icon="icons:chevron-left" on-click="moveLeft"></paper-icon-button>
                                <paper-icon-button title="move right" icon="icons:chevron-right" on-click="moveRight"></paper-icon-button>
                                <paper-icon-button title="zoom out" icon="icons:zoom-out" on-click="zoomOut"></paper-icon-button>
                                <paper-icon-button title="zoom in" icon="icons:zoom-in" on-click="zoomIn"></paper-icon-button>
                            </div>
                            <div class="flexchild" on-mouseover="locationHovered" on-mouseout="locationUnhovered">
                                <paper-input id="textRange" value="{{_strRange]]" label="Chromosome Location" on-change="_updateStrRange"></paper-input>
                            </div>
                            <div class="flexchild">
                                <paper-autocomplete id="geneSearch" label="Search Gene/Probe" remote-source="true" min-length="2" 
                                    on-autocomplete-selected="_selectGene"
                                    on-autocomplete-change="_searchGene"
                                    value-property="gene"
                                    text-property="gene">
                                    <template autocomplete-custom-template>
                                        <paper-item on-tap="_onSelect" id$="[[_getSuggestionId(index)]]" role="option" aria-selected="false">
                                        <div>[[item.gene]] [[item.seqName]]: [[item.start]] - [[item.end]]</div>
                                        <paper-ripple></paper-ripple>
                                        </paper-item>
                                    </template>
                                </paper-autocomplete>
                            </div>
                        </div>
                        <div id="chartContainer" class="content">
                            <div class="isempty" hidden$="{{_isEmpty}}">Add a New Chart to the Workspace</div>
                            <!-- <epiviz-genes-track class="charts" measurements="{{geneMeasurements}}"></epiviz-genes-track> -->
                            <content id="chartNav" select=".charts"></content>
                        </div>

                    </iron-collapse>
                <!-- </template> -->
            </div>
    </template>

    <script>
        Polymer({
            /* Custom element html tag */
            is: 'epiviz-navigation',
            behaviors: [epiviz.ChartDataBehavior, epiviz.ChartAddBehavior, epiviz.ChartWorkspaceBehavior, Polymer.IronResizableBehavior, epiviz.ChartGridBehavior],

            /* Properties that can be defined on the element */
            properties: {

                /**
                 * Chromosome location.
                 * Default Location Attribute to set to all the children chart elements.
                 *
                 * @example: chr1
                 *
                 * @type {string}
                 */
                chr: {
                    type: String,
                    notify: true
                },

                /**
                 * Chromosome start. 
                 * Default Chromosome start value to use. (defaults to 0).
                 *
                 * @type {number}
                 */
                start: {
                    type: Number,
                    notify: true
                },

                /**
                 * Chromosome end. 
                 * Default Chromosome end value to use. (defaults to the `<chr>` length).
                 *
                 * @type {number}
                 */
                end: {
                    type: Number,
                    notify: true
                },

                /**
                 * Updates location attributes(chr, start, end) to this gene's location.
                 *
                 * @type {string}
                 */
                gene: {
                    type: String,
                    observer: '_geneUpdate'
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {Object<epiviz.datatypes.GenomicRange>}
                 */
                range: {
                    type: Object,
                    observer: '_rangeUpdate',
                    notify: true
		            // computed: 'getGenomicRange(chr, start, end)'
                },

                /**
                 * Computed Range from `<chr>`, `<start>` & `<end>`. 
                 *
                 * @type {string}
                 */        
                _strRange: {
                    type: String,
                    notify: true
		            // computed: 'getStrRange(chr, start, end)'
                },


                _headerName: {
                    type: String,
                    notify: true,
                    value : "enableHeader"
                },

                _toggleText: {
                    type: String,
                    notify: true,
                    computed: '_computeToggleText(collapsed)'
                },

                /**
                 * Default scroll left/right ratio
                 *
                 * @type {number}
                 */   
                stepRatio: {
                    type: Number,
                    notify: true,
                    value: 0.2
                },

                /**
                 * Default zoom in/out ratio
                 *
                 * @type {number}
                 */   
                zoomRatio: {
                    type: Number,
                    notify: true,
                    value: 0.2
                },

                /**
                 * Whether the element is collapsed
                 *
                 * @type {boolean}
                 */   
                collapsed: {
                    type: Boolean,
                    notify: true,
                    value: function () {
                        return true;
                    }
                },

                /**
                 * Whether the element has no children
                 *
                 * @type {boolean}
                 */   
                _isEmpty: {
                    type: Boolean,
                    notify: true,
                    value: function () {
                        return false;
                    }
                },

                /**
                 * Current gene in range (set automatically)
                 *
                 * @type {string}
                 */   
                geneInRange: {
                    type: String,
                    notify: true
                },

                headerClassName: {
                    type: String,
                    notify: true
                },

                noLogo: {
                    type: Boolean,
                    notify: true,
                    reflectToAttribute: true,
                    value: false
                },
                measurements: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                },

                /**
                 * Default chart properties for navigation element.
                 *
                 * @type {Object}
                 */  
                configSrc: {
                    type: Object,
                    notify: true,
                    value: function() {
                        epiviz.Config.SETTINGS = {
                            dataProviders: [
                                ["epiviz.data.WebServerDataProvider", "umd", "https://epiviz.cbcb.umd.edu/data/main.php"]
                            ],
                            workspacesDataProvider: sprintf('epiviz.data.EmptyResponseDataProvider', 'empty', ''),
                            useCache: true,
                            colorPalettes: [],
                            maxSearchResults: 12
                        };
                        return epiviz.Config.SETTINGS;
                    }
                },

                geneMeasurements: {
                    type: Object,
                    notify: true 
                }
            },

            /* event listeners */
            listeners: {
                'hover': 'onHover',
                'unHover': 'onUnhover',
                'select': 'onSelect',
                'deSelect': 'onDeselect',
                // 'iron-resize': '_onResize'
                // 'transitionend': '_onResize'
            },

            /**
             * Resizes the chart.
             */
             _onResize: function() {
                var self = this;
                var numChildren = self.getEffectiveChildren().length;
                if(numChildren > 0) {self.set('_isEmpty', true);}
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild.nodeName.indexOf("-JSON-") != -1) {
                        currentChild.$.epivizChart._onResize();
                    }
                    else {
                        currentChild._onResize();
                    }
                }
            },

            _computeToggleText: function(collapsed) {
                if(collapsed) {
                    return "Expand";
                }
                return "Collapse";
            },

            toggleSelected: function(event) {
                $(event.target).parent().parent()[0].selected = null;
            },

            /**
             * Toggle handler (expand/collapse)
             */
            toggleHeader: function(event) {
                var self = this;
                this.$.navHeader.toggle();
                this.collapsed = !this.collapsed;
                // unselect the selected paper-item;
                this.toggleSelected(event);
                // unsafe to reference index 0, but works for now
                var menuButton = $(this).find("paper-menu-button")[0];
                menuButton.close();
                if (this.collapsed) {
                    Polymer.dom(self).unobserveNodes(self._observer);
                    // setTimeout(function() {
                    //     self.$.navTrack._draw();
                    // }, 500);
                } else {
                    self._observer =
                    Polymer.dom(self.$$("#chartNav")).observeNodes(function(info) {
                        info.addedNodes.forEach(function(node) {
                            node._parentContainer = self;
                            if(node.nodeName.indexOf("EPIVIZ-") != -1 && node.nodeName.indexOf("JSON") == -1) {
                                var measurements = self.measurements;
                                if(self._parentContainer) {
                                    measurements = self._parentContainer.measurements;
                                }
                                if(!node.data) {
                                    self._getElementData(node, self, measurements);
                                }
                            }
                        });
                        self.saveWorkspace();
                    });
                }
                self._onResize();

                if(event) {
                    event.preventDefault();
                    event.stopPropagation();
                }
            },

            /**
             * Hover event handler.
             * Listens to hover events fired from its children elements and propagates to other charts.
             *
             * @fires hoverAllCharts
             */
            onHover: function(e) {
                /**
                 * Propogates hover event to other charts.
                 *
                 * @event hoverAllCharts
                 * @type {object}
                 * @property {object} data - data object currently hovered.
                 */
                this.fire('hoverAllCharts', {
                    data: e.detail.data
                });               
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * Unhover event handler.
             * Listens to unhover events fired from its children elements and propagates to other charts
             * 
             * @fires unHoverAllCharts
             */
            onUnhover: function(e) {
                /**
                 * Propogates unHover event to other charts.
                 *
                 * @event unHoverAllCharts
                 */
                this.fire('unHoverAllCharts', {
                    data: null
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * Select event handler.
             * Listens to select events fired from its children elements and propagates to other charts.
             *
             * @fires selectAllCharts
             */
             onSelect: function(e) {
                /**
                 * Propogates select event to other charts.
                 *
                 * @event selectAllCharts
                 * @type {object}
                 * @property {object} data - data object currently selected.
                 */
                if(e.detail && e.detail.data) {
                    this.fire('selectAllCharts', {
                        data: e.detail.data
                    });
                }
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * deSelect event handler.
             * Listens to select events fired from its children elements and propagates to other charts.
             *
             * @fires unSelectAllCharts
             */
             onDeselect: function(e) {
                /**
                 * Propogates select event to other charts.
                 *
                 * @event unSelectAllCharts
                 */
                this.fire('unSelectAllCharts', {
                    data: null
                });
                e.preventDefault();
                e.stopPropagation();
            },

            /**
             * ChartLocation/RangeChange event handler.Z
             */
            _rangeUpdate: function() {
                var self = this;
                self.chartObject = new epiviz.ui.charts.ChartObject(self.plotId, self.start, self.end, undefined, undefined, undefined, undefined, undefined, self.chr);

                self._getGenesInRange(self, self);
                
                var numChildren = self.getEffectiveChildren().length;
                if(numChildren > 0) {self.set('_isEmpty', true);}
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    if(currentChild.nodeName.indexOf("EPIVIZ-") != -1 && currentChild.nodeName.indexOf("JSON") == -1) {
                        currentChild.set("_hideLoader", false);
                        currentChild.range = self.range;
                        var measurements = self.measurements;
                        if(self._parentContainer) {
                            measurements = self._parentContainer.measurements;
                        }
                        self._getElementData(currentChild, self, measurements);
                    }
                }

                self.fire('navigationRangeUpdate', {
                    plotId: self.plotId,
                    range: self.range
                });
            },

            /**
             * GeneLocationChange event handler.
             */
            _geneUpdate: function() {
                var self = this;
                self._getElementSearch(self.gene, null, null, function(data) {
                    self.chr = data[0].seqName;
                    self.start = data[0].start;
                    self.end = data[0].end;
                });
            },

            /**
             * Search handler for a gene (gene search field).
             * 
             * @param {string} keyword search string is at e.detail.option.text
             */
            _searchGene: function(e) {
                var self = this;
                var gene = e.detail.option.text;
                var field = this.$$("#geneSearch");

                if (self.useDefaultDataProvider) {

                    self.range = self.range || new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                    var dataProviderFactory = new epiviz.data.DataProviderFactory(new epiviz.Config(self.configSrc));
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.search(function(data) {
                        field.suggestions(data);
                    }, gene);
                }
                else {
                    var result = self._getElementSearch(gene, self, self);  
                }
            },

            /**
             * Update Location Attributes when a gene is selected.
             * selected gene value @ e.detail.option
             */
            _selectGene: function(e) {
                var selected= e.detail.option;

                this.chr = selected.seqName;
                this.start = selected.start - Math.round(selected.start * 0.01);
                this.end = selected.end + Math.round(selected.end * 0.01);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
                this._strRange = this.getStrRange(this.chr, this.start, this.end);
            },

            /**
             * Handles location change (gene location field)
             */
            _updateStrRange: function(e) {
                var update = e.target.value;
                var split = update.split(":");
                var chr = split[0];
                var rsplit = split[1].split("-");
                var start = parseInt(rsplit[0]);
                var end = parseInt(rsplit[1]);
                var width = end - start;

                if(chr in this.seqInfo) {
                    this.chr = chr;
                    this.end = Math.min(end, this.seqInfo[this.chr].max);
                    if(start > this.end) {
                        start = this.end - width;
                    }
                    this.start = Math.max(0, start);

                    this.range = this.getGenomicRange(this.chr, this.start, this.end);
                }
                else {
                    var toast = document.createElement("paper-toast");
                    toast.setAttribute("text", "Chromosome does not exist");
                    // toast.setAttribute("openned", true);
                    Polymer.dom(this.root).appendChild(toast);
                    toast.show();
                }
            },

            /**
             * Navigation handler - move left
             */
            moveLeft: function(e) {
                var width = this.end - this.start;
                var newStart = this.start - Math.round(width * this.stepRatio);
                var newEnd = newStart + width;
                
                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
                this._strRange = this.getStrRange(this.chr, this.start, this.end);
            },

            /**
             * Navigation handler - move right
             */
            moveRight: function(e) {
                var width = this.end - this.start;
                var newStart = this.start + Math.round(width * this.stepRatio);
                var newEnd = newStart + width;

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
                this._strRange = this.getStrRange(this.chr, this.start, this.end);
            },

            /**
             * Navigation handler - zoom in 
             */
            zoomIn: function(e) {
                var width = Math.round(this.end - this.start);
                var mid = Math.round(this.start + (width/2));
                var newWidth = Math.round(width * (1 - this.zoomRatio));
                var newStart = Math.round(mid - (newWidth * 0.5));
                var newEnd = Math.round(this.start + newWidth);

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
                this._strRange = this.getStrRange(this.chr, this.start, this.end);
            },

            /**
             * Navigation handler - zoom out
             */
            zoomOut: function(e) {
                var width = Math.round(this.end - this.start);
                var mid = Math.round(this.start + (width/2));
                var newWidth = Math.round(width * (1 + this.zoomRatio));
                var newStart = Math.round(mid - (newWidth * 0.5));
                var newEnd = Math.round(this.start + newWidth);

                this.start = Math.max(0, newStart);
                this.end = Math.min(newEnd, this.seqInfo[this.chr].max);

                this.range = this.getGenomicRange(this.chr, this.start, this.end);
                this._strRange = this.getStrRange(this.chr, this.start, this.end);
            },

            /**
             * String formatted Range
             * 
             * @param {string} chr chromosome location
             * @param {number} start chromosome start
             * @param {number} end chromosome end
             *
             * @return {string} range in string format
             */
            getStrRange: function(chr, start, end) {
                return chr + ": " + start + " - " + end;
            },

            /**
             * String formatted Range
             * 
             * @param {string} chr chromosome location
             * @param {number} start chromosome start
             * @param {number} end chromosome end
             *
             * @return {epiviz.datatypes.GenomicRange} Genomic Range object
             */
            getGenomicRange: function(chr, start, end) {
                return new epiviz.datatypes.GenomicRange(chr, start, end-start);
            },

            /**
             * Handles data when charts are first initialized.
             */
            _getData: function() {
                var self = this;
                var numChildren = self.getEffectiveChildren().length;
                if(numChildren > 0) {self.set('_isEmpty', true);}
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    if(currentChild == undefined || currentChild.plotId == undefined) {return ;}
                    currentChild.range = self.range;
                    currentChild.set("_hideLoader", false);
                    currentChild._parentContainer = self;
                    var measurements = self.measurements;
                    if(self._parentContainer) {
                        measurements = self._parentContainer.measurements;
                    }
                    self._getElementData(currentChild, self, measurements);
                }
            },

            /**
             * Clones a navigation element and add it to the page
             */
            cloneNavigation: function(event) {
                var self = this;

                this.toggleSelected(event);
                var navElem = document.createElement('epiviz-navigation');
                navElem.chr = self.chr;
                navElem.start = self.start;
                navElem.end = self.end;
                navElem.className = "charts";

                Polymer.dom(self.parentNode).appendChild(navElem);

                var numChildren = self.getEffectiveChildren().length;
                if(numChildren > 0) {self.set('_isEmpty', true);}
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    var childElem = document.createElement(currentChild.nodeName);
                    childElem.className = "charts";
                    childElem.dimS = currentChild.dimS;
                    childElem.measurements = currentChild.measurements;
                    childElem.chartSettings = currentChild.chartSettings;
                    childElem.chartColors = currentChild.chartColors;
                    childElem._parentContainer = self;
                    Polymer.dom(navElem).appendChild(childElem);
                }
            },

            /**
             * Handles when mouse-overed on a ramge element.
             */
            locationHovered: function() {
                var self = this;
                if(!self.$.textRange.focused) {
                    self.fire('hover', {
                        data: self.chartObject
                    });
                }
            },

            /**
             * Handles when mouse-out on a range element.
             */
            locationUnhovered: function() {
                var self = this;
                self.fire('unHover', {
                    data: null
                });
            },

            // Initialization that should happen or use FactoryImpl 
            created: function() {
                var self = this;
                self._getElementSeqInfo(self, self);
            },
            
            /* callback function after the element is attached to the DOM */
            attached: function() {

                var self = this;
                $(this).find("#chartContainer").sortable({
                    delay: 150,
                });
                
                self.collapsed = false;

                if(!self.dataManager) {
                    self._headerName = "disableHeader";
                }

                if (self.useDefaultDataProvider) {

                    var dataProviderFactory = new epiviz.data.DataProviderFactory(new epiviz.Config(self.configSrc));
                    var dataManager = new epiviz.data.DataManager(self.config, dataProviderFactory);

                    dataManager.getSeqInfos(function(data) {
                        var seqinfo = {};
                        data.forEach(function(s) {
                            seqinfo[s.seqName] = s;
                        });
                        self.seqInfo = seqinfo;
                    });
                }

                if(self.gene) {
                    self._getElementSearch(self.gene, null, null, function(data) {
                        self.chr = data[0].seqName;
                        self.start = data[0].start;
                        self.end = data[0].end;
                        self.range = self.getGenomicRange(self.chr, self.start, self.end);
                        self._strRange = self.getStrRange(self.chr, self.start, self.end);

                        self.chartObject = new epiviz.ui.charts.ChartObject(self.plotId, self.start, self.end, undefined, undefined, undefined, undefined, undefined, self.chr);
                    });
                }
                else if(self.chr && self.start && self.end) {
                    self.range = self.getGenomicRange(self.chr, self.start, self.end);
                    self._strRange = self.getStrRange(self.chr, self.start, self.end);

                    self.chartObject = new epiviz.ui.charts.ChartObject(self.plotId, self.start, self.end, undefined, undefined, undefined, undefined, undefined, self.chr);
                }

                if(!self.collapsed) {
                    self._observer =
                    Polymer.dom(self.$$("#chartNav")).observeNodes(function(info) {
                        info.addedNodes.forEach(function(node) {
                            node._parentContainer = self;
                            if(node.nodeName.indexOf("EPIVIZ-") != -1 && node.nodeName.indexOf("JSON") == -1) {
                                // self._updateChart(node.plotId);
                                var measurements = self.measurements;
                                if(self._parentContainer) {
                                    measurements = self._parentContainer.measurements;
                                }
                                self._getElementData(node, self, measurements);

                                self.set('_isEmpty', true);
                            }
                        });
                        self.saveWorkspace();
                    });
                }

                self.$.addChart._parentContainer = self;
            },

            _measurementsChanged: function() {
                // console.log("ovverriding measurementsChanged function");
            },

            _rangeChanged: function() { 
                // console.log("overriding rangeChanged function");
            },

            /* callback function after the element is initialized */
            ready: function() {
                var self = this;

                self.plotId = "123211124" //self.plotId || self._generatePlotId();
                self.config = new epiviz.Config(self.configSrc);
                // self.range = self.getGenomicRange(self.chr, self.start, self.end);

                if(self.transformDataFunc) {
                    self.transformFunc = new Function('return ' + self.transformDataFunc);
                }
                else {
                    self.transformFunc = self.epivizToJSON;
                }

                self._initializeAddDialog();
                self._initializeGrid();
            },

            /**
             * Creates an instance of the navigation element.
             *
             * @return {null} for consistency with other chart elements
             */
            _createChart: function() {
                return null;
            }
        });
    </script>
</dom-module>